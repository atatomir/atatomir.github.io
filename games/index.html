<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Games • TATOMIR N. ALEX</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark:#0b0d10;
  --bg-deep:#0f172a;
  --panel: rgba(255,255,255,0.06);
  --ink:#f5f7fa;
  --muted:#9aa3b2;
  --accent:#4f8cff;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  font-family: 'Inter', sans-serif;
  color: var(--ink);
  line-height:1.7;
  background: linear-gradient(180deg, #0b0d10 0%, #0f172a 100%);
  background-attachment: fixed;
  background-size: cover;
}

/* NAV */
nav{
  position: fixed;
  top:20px;
  left:50%;
  transform: translateX(-50%);
  z-index:100;
  backdrop-filter: blur(16px);
  background: var(--panel);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:999px;
  padding:10px 22px;
  display:flex;
  gap:16px;
  align-items:center;
}
nav a{
  color: var(--muted);
  text-decoration: none;
  font-weight:500;
  margin:0 10px;
  font-size:14px;
}
nav a:hover{color: var(--accent);}
#lang-toggle{
  margin-left:12px;
  cursor:pointer;
  background: var(--accent);
  border:none;
  border-radius:999px;
  padding:6px 12px;
  font-weight:600;
  color:white;
  font-size:13px;
  transition:0.2s;
}
#lang-toggle:hover{background:#3570d1;}

/* SECTIONS */
section{
  max-width:1100px;
  margin:0 auto;
  padding:120px 24px 60px;
}
.section-title{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.18em;
  color:var(--muted);
  margin-bottom:18px;
}
.section-heading{
  font-size: clamp(2rem, 4vw, 2.8rem);
  font-weight:700;
  letter-spacing:-0.02em;
  margin-bottom:28px;
}

/* REVEAL ANIMATION */
.reveal{
  opacity:0;
  transform: translateY(24px);
  transition:0.8s ease;
}
.reveal.visible{
  opacity:1;
  transform:none;
}

/* FOOTER */
footer{
  text-align:center;
  padding:60px 24px 40px;
  color:var(--muted);
  font-size:13px;
  border-top:1px solid rgba(255,255,255,0.06);
}

/* GAMES LAYOUT */
#games{text-align:center;}
.games-row{
  display:flex;
  gap:32px;
  justify-content:center;
  align-items:flex-start;
  flex-wrap:wrap;
}
.game-col{
  flex:0 1 440px;
  min-width:0;
}

/* SNAKE GAME */
.snake-score-bar{
  display:flex;
  justify-content:center;
  gap:32px;
  margin-bottom:18px;
  font-size:14px;
  color:var(--muted);
}
.snake-score-bar span{color:var(--accent);font-weight:600;}
.snake-canvas-wrap{
  position:relative;
  display:inline-block;
  border-radius:14px;
  overflow:hidden;
  border:2px solid rgba(79,140,255,0.35);
  box-shadow:0 0 30px rgba(79,140,255,0.1);
}
#snake-canvas{display:block;background:#0b0d10;max-width:100%;height:auto;}
.snake-overlay{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  background:rgba(11,13,16,0.82);
  backdrop-filter:blur(6px);
  z-index:2;
  transition:opacity 0.3s;
}
.snake-overlay.hidden{opacity:0;pointer-events:none;}
.snake-overlay h3{font-size:1.6rem;margin-bottom:8px;}
.snake-overlay p{color:var(--muted);margin-bottom:18px;font-size:0.95rem;}
.snake-overlay .snake-final-score{font-size:2rem;font-weight:700;color:var(--accent);margin-bottom:6px;}
.snake-btn{
  padding:12px 28px;border:none;border-radius:999px;
  background:var(--accent);color:#fff;font-weight:600;font-size:14px;
  cursor:pointer;transition:0.2s;margin:4px;
}
.snake-btn:hover{background:#3570d1;transform:translateY(-1px);}
.snake-btn.secondary-btn{
  background:transparent;border:1px solid rgba(255,255,255,0.15);color:var(--ink);
}
.snake-btn.secondary-btn:hover{background:rgba(255,255,255,0.05);}
.snake-initials-input{
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);
  border-radius:8px;padding:8px 12px;color:var(--ink);font-size:1rem;
  text-align:center;width:80px;text-transform:uppercase;font-weight:600;
  margin-bottom:10px;outline:none;
}
.snake-initials-input:focus{border-color:var(--accent);}
.snake-leaderboard{
  margin:28px auto 0;max-width:340px;
  backdrop-filter:blur(16px);background:var(--panel);
  border:1px solid rgba(255,255,255,0.08);border-radius:14px;
  padding:20px 24px;
}
.snake-leaderboard h4{font-size:13px;text-transform:uppercase;letter-spacing:0.14em;color:var(--muted);margin-bottom:12px;}
.snake-leaderboard table{width:100%;border-collapse:collapse;font-size:14px;}
.snake-leaderboard th{color:var(--muted);font-weight:500;text-align:left;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
.snake-leaderboard td{padding:6px 0;}
.snake-leaderboard td:last-child{text-align:right;color:var(--accent);font-weight:600;}
.snake-dpad{
  display:none;
  margin:18px auto 0;
  width:160px;height:160px;
  position:relative;
}
.snake-dpad button{
  position:absolute;width:50px;height:50px;
  border:none;border-radius:10px;
  background:var(--panel);backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--ink);font-size:20px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:0.15s;-webkit-tap-highlight-color:transparent;
  user-select:none;
}
.snake-dpad button:active{background:rgba(79,140,255,0.25);}
.snake-dpad .d-up{top:0;left:55px;}
.snake-dpad .d-down{bottom:0;left:55px;}
.snake-dpad .d-left{top:55px;left:0;}
.snake-dpad .d-right{top:55px;right:0;}

/* TRADING GAME */
.trade-panel{
  position:relative;
  backdrop-filter:blur(16px);background:var(--panel);
  border:1px solid rgba(255,255,255,0.08);border-radius:14px;
  padding:20px;text-align:center;
}
.trade-panel h3{font-size:1.1rem;font-weight:600;margin-bottom:12px;}
.trade-info{
  display:flex;justify-content:center;margin-bottom:14px;font-size:13px;color:var(--muted);
}
.trade-info > div{flex:1 1 0;min-width:0;text-align:center;}
.trade-info span{display:block;font-size:1.05rem;font-weight:600;color:var(--ink);margin-top:2px;font-variant-numeric:tabular-nums;}
.trade-info .pnl-pos{color:#34d399;}
.trade-info .pnl-neg{color:#ef4444;}
.trade-canvas-wrap{
  position:relative;border-radius:10px;overflow:hidden;
  border:1px solid rgba(255,255,255,0.08);margin-bottom:14px;
}
#trade-canvas{display:block;width:100%;height:auto;}
.trade-overlay{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(11,13,16,0.82);backdrop-filter:blur(6px);z-index:2;transition:opacity 0.3s;
}
.trade-overlay.hidden{opacity:0;pointer-events:none;}
.trade-overlay h3{font-size:1.4rem;margin-bottom:6px;}
.trade-overlay p{color:var(--muted);margin-bottom:14px;font-size:0.9rem;}
.trade-result{font-size:1.8rem;font-weight:700;margin-bottom:10px;}
.trade-btns{display:flex;gap:8px;justify-content:center;}
.trade-btn{
  padding:10px 22px;border:none;border-radius:999px;
  font-weight:600;font-size:14px;cursor:pointer;transition:0.2s;
}
.trade-btn:hover{transform:translateY(-1px);}
.trade-btn.buy{background:#34d399;color:#0b0d10;}
.trade-btn.buy:hover{background:#2ab884;}
.trade-btn.sell{background:#ef4444;color:#fff;}
.trade-btn.sell:hover{background:#d63535;}
.trade-btn.start{background:var(--accent);color:#fff;}
.trade-btn.start:hover{background:#3570d1;}
.trade-position-bar{
  display:flex;align-items:center;justify-content:center;gap:6px;
  margin-bottom:14px;font-size:13px;color:var(--muted);
}
.trade-pos-dots{display:flex;gap:2px;align-items:center;}
.trade-pos-dot{
  width:7px;height:7px;border-radius:50%;
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  transition:0.15s;
}
.trade-pos-dot.zero{width:9px;height:9px;border-color:rgba(255,255,255,0.25);}
.trade-pos-dot.long{background:#34d399;border-color:#34d399;}
.trade-pos-dot.short{background:#ef4444;border-color:#ef4444;}
.trade-timer{
  height:3px;background:rgba(255,255,255,0.06);border-radius:2px;margin-bottom:14px;overflow:hidden;
}
.trade-timer-fill{height:100%;background:var(--accent);transition:width 0.1s linear;width:0%;}
.trade-btn.end{background:transparent;border:1px solid rgba(255,255,255,0.15);color:var(--ink);}
.trade-btn.end:hover{background:rgba(255,255,255,0.05);}
.trade-hint{margin-top:10px;font-size:11px;color:var(--muted);line-height:1.6;}
.trade-hint kbd{
  display:inline-block;padding:1px 6px;border-radius:4px;font-size:10px;font-family:inherit;
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  color:var(--ink);vertical-align:1px;
}
.trade-paused-badge{
  display:none;align-items:center;justify-content:center;gap:6px;
  margin-bottom:10px;font-size:13px;font-weight:600;color:#fbbf24;
}
.trade-paused-badge.visible{display:flex;}
.trade-log{margin-top:16px;}
.trade-log h4{font-size:13px;text-transform:uppercase;letter-spacing:0.14em;color:var(--muted);margin-bottom:10px;}
.trade-log-scroll{max-height:150px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.1) transparent;}
.trade-log table{width:100%;border-collapse:collapse;font-size:12px;font-variant-numeric:tabular-nums;}
.trade-log th{color:var(--muted);font-weight:500;text-align:left;padding:3px 4px;border-bottom:1px solid rgba(255,255,255,0.06);font-size:11px;position:sticky;top:0;background:rgba(15,23,42,0.95);}
.trade-log td{padding:4px;white-space:nowrap;}
.trade-log td:last-child{text-align:right;font-weight:600;}
.lb-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.lb-header h4{margin:0;}
.lb-clear-btn{
  background:none;border:none;color:var(--muted);font-size:14px;
  cursor:pointer;padding:2px 4px;border-radius:4px;transition:0.2s;line-height:1;
}
.lb-clear-btn:hover{color:#ef4444;background:rgba(239,68,68,0.1);}
.trade-lb{margin-top:16px;}
.trade-lb h4{font-size:13px;text-transform:uppercase;letter-spacing:0.14em;color:var(--muted);margin-bottom:10px;}
.trade-lb table{width:100%;border-collapse:collapse;font-size:14px;}
.trade-lb th{color:var(--muted);font-weight:500;text-align:left;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
.trade-lb td{padding:6px 0;}
.trade-lb td:last-child{text-align:right;font-weight:600;}

/* GAME SETTINGS (shared) */
.game-settings-btn{
  position:absolute;top:12px;right:12px;
  background:none;border:none;color:var(--muted);font-size:18px;
  cursor:pointer;padding:4px 6px;border-radius:6px;transition:0.2s;z-index:3;
}
.game-settings-btn:hover{color:var(--ink);background:rgba(255,255,255,0.08);}
.game-settings-modal{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(11,13,16,0.88);backdrop-filter:blur(8px);z-index:10;
  transition:opacity 0.3s;
}
.game-settings-modal.hidden{opacity:0;pointer-events:none;}
.game-settings-inner{width:85%;max-width:300px;text-align:left;}
.game-settings-inner h4{font-size:13px;text-transform:uppercase;letter-spacing:0.14em;color:var(--muted);margin-bottom:14px;text-align:center;}
.game-settings-row{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:10px;font-size:13px;color:var(--ink);
}
.game-settings-row label{color:var(--muted);}
.game-settings-select{
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  border-radius:6px;padding:4px 8px;color:var(--ink);font-size:12px;
  font-family:inherit;outline:none;cursor:pointer;
}
.game-settings-select:focus{border-color:var(--accent);}
.game-settings-close{
  margin-top:10px;width:100%;padding:8px;border:none;border-radius:8px;
  background:rgba(255,255,255,0.08);color:var(--ink);font-weight:600;font-size:12px;
  cursor:pointer;transition:0.2s;font-family:inherit;
}
.game-settings-close:hover{background:rgba(255,255,255,0.15);}

/* RESPONSIVE */
@media (max-width:768px){
  .section-heading{font-size:2rem;}
  nav a{font-size:13px; margin:0 8px;}
  .snake-dpad{display:block;}
  .games-row{flex-direction:column;align-items:center;}
}
</style>
</head>
<body>

<nav>
  <a href="/" data-en="Home" data-ro="Acasă">Home</a>
  <a href="/games" data-en="Games" data-ro="Jocuri">Games</a>
  <button id="lang-toggle">RO</button>
</nav>

<section id="games" class="reveal">
  <div class="section-title" data-en="Mini Games" data-ro="Mini Jocuri">Mini Games</div>
  <div class="section-heading" data-en="Take a Break" data-ro="Ia o Pauză">Take a Break</div>
  <div class="games-row">

    <!-- SNAKE -->
    <div class="game-col">
      <div class="snake-score-bar">
        <div><span data-en="Score" data-ro="Scor">Score</span>: <span id="snake-score">0</span></div>
        <div><span data-en="Best" data-ro="Record">Best</span>: <span id="snake-high">0</span></div>
      </div>
      <div class="snake-canvas-wrap">
        <button class="game-settings-btn" id="snake-settings-btn" title="Settings">&#9881;</button>
        <div class="game-settings-modal hidden" id="snake-settings-modal">
          <div class="game-settings-inner">
            <h4>Settings</h4>
            <div class="game-settings-row">
              <label>Speed</label>
              <select class="game-settings-select" id="ss-speed">
                <option value="slow">Slow</option>
                <option value="normal" selected>Normal</option>
                <option value="fast">Fast</option>
              </select>
            </div>
            <div class="game-settings-row">
              <label>Green Gems</label>
              <select class="game-settings-select" id="ss-gems">
                <option value="rare">Rare</option>
                <option value="normal" selected>Normal</option>
                <option value="frequent">Frequent</option>
              </select>
            </div>
            <div class="game-settings-row">
              <label>Purple Gems</label>
              <select class="game-settings-select" id="ss-shrink">
                <option value="rare">Rare</option>
                <option value="normal" selected>Normal</option>
                <option value="frequent">Frequent</option>
              </select>
            </div>
            <div class="game-settings-row">
              <label>Bombs</label>
              <select class="game-settings-select" id="ss-bombs">
                <option value="off">Off</option>
                <option value="rare">Rare</option>
                <option value="normal" selected>Normal</option>
                <option value="frequent">Frequent</option>
              </select>
            </div>
            <div class="game-settings-row">
              <label>Walls</label>
              <select class="game-settings-select" id="ss-walls">
                <option value="on" selected>Solid</option>
                <option value="off">Wrap Around</option>
              </select>
            </div>
            <button class="game-settings-close" id="ss-close">Close</button>
          </div>
        </div>
        <canvas id="snake-canvas" width="400" height="400"></canvas>
        <div class="snake-overlay" id="snake-overlay-start">
          <h3 data-en="Snake" data-ro="Snake">Snake</h3>
          <p data-en="Use arrow keys or WASD to play" data-ro="Folosește săgețile sau WASD">Use arrow keys or WASD to play</p>
          <button class="snake-btn" id="snake-start-btn" data-en="Start Game" data-ro="Începe Jocul">Start Game</button>
        </div>
        <div class="snake-overlay hidden" id="snake-overlay-pause">
          <h3 data-en="Paused" data-ro="Pauză">Paused</h3>
          <p data-en="Press Space or click to resume" data-ro="Apasă Space sau click pt. reluare">Press Space or click to resume</p>
          <button class="snake-btn" id="snake-resume-btn" data-en="Resume" data-ro="Reia">Resume</button>
        </div>
        <div class="snake-overlay hidden" id="snake-overlay-end">
          <h3 data-en="Game Over" data-ro="Joc Terminat">Game Over</h3>
          <div class="snake-final-score" id="snake-final-score">0</div>
          <button class="snake-btn" id="snake-restart-btn" data-en="Play Again" data-ro="Joacă Din Nou">Play Again</button>
        </div>
      </div>
      <div class="snake-dpad">
        <button class="d-up" data-dir="up">&#9650;</button>
        <button class="d-down" data-dir="down">&#9660;</button>
        <button class="d-left" data-dir="left">&#9664;</button>
        <button class="d-right" data-dir="right">&#9654;</button>
      </div>
      <div class="snake-leaderboard">
        <div class="lb-header">
          <h4 data-en="Best Scores" data-ro="Cele Mai Bune Scoruri">Best Scores</h4>
          <button class="lb-clear-btn" id="snake-clear-lb" title="Clear leaderboard"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg></button>
        </div>
        <table>
          <thead><tr>
            <th data-en="#" data-ro="#">#</th>
            <th data-en="Score" data-ro="Scor">Score</th>
            <th data-en="Date" data-ro="Data">Date</th>
          </tr></thead>
          <tbody id="snake-lb-body"></tbody>
        </table>
      </div>
    </div>

    <!-- TRADING -->
    <div class="game-col">
      <div class="trade-panel">
        <h3 data-en="SPY Day Trader" data-ro="SPY Day Trader">SPY Day Trader</h3>
        <button class="game-settings-btn" id="game-settings-btn" title="Settings">&#9881;</button>
        <div class="game-settings-modal hidden" id="game-settings-modal">
          <div class="game-settings-inner">
            <h4>Settings</h4>
            <div class="game-settings-row">
              <label>Data Source</label>
              <select class="game-settings-select" id="ts-source">
                <option value="real">Real (Yahoo)</option>
                <option value="simulated">Simulated</option>
              </select>
            </div>
            <div class="game-settings-row">
              <label>Duration</label>
              <select class="game-settings-select" id="ts-duration">
                <option value="10">10s</option>
                <option value="30" selected>30s</option>
                <option value="60">60s</option>
                <option value="300">300s</option>
              </select>
            </div>
            <div class="game-settings-row">
              <label>P&amp;L Display</label>
              <select class="game-settings-select" id="ts-pnlmode">
                <option value="total">Total</option>
                <option value="split" selected>Realized + Unrealized</option>
              </select>
            </div>
            <div class="game-settings-row">
              <label>Position Tint</label>
              <select class="game-settings-select" id="ts-postint">
                <option value="on" selected>On</option>
                <option value="off">Off</option>
              </select>
            </div>
            <button class="game-settings-close" id="ts-close">Close</button>
          </div>
        </div>
        <div class="trade-timer"><div class="trade-timer-fill" id="trade-timer-fill"></div></div>
        <div class="trade-info">
          <div><small data-en="Price" data-ro="Preț">Price</small><span id="trade-price">—</span></div>
          <div><small data-en="Position" data-ro="Poziție">Position</small><span id="trade-pos">0</span></div>
          <div id="trade-pnl-total"><small data-en="P&amp;L" data-ro="Profit">P&amp;L</small><span id="trade-pnl">$0.00</span></div>
          <div id="trade-pnl-realized" style="display:none"><small>Realized</small><span id="trade-rpnl">$0.00</span></div>
          <div id="trade-pnl-unrealized" style="display:none"><small>Unrealized</small><span id="trade-upnl">$0.00</span></div>
        </div>
        <div class="trade-position-bar">
          <small>-1000</small>
          <div class="trade-pos-dots">
            <div class="trade-pos-dot" data-i="-10"></div>
            <div class="trade-pos-dot" data-i="-9"></div>
            <div class="trade-pos-dot" data-i="-8"></div>
            <div class="trade-pos-dot" data-i="-7"></div>
            <div class="trade-pos-dot" data-i="-6"></div>
            <div class="trade-pos-dot" data-i="-5"></div>
            <div class="trade-pos-dot" data-i="-4"></div>
            <div class="trade-pos-dot" data-i="-3"></div>
            <div class="trade-pos-dot" data-i="-2"></div>
            <div class="trade-pos-dot" data-i="-1"></div>
            <div class="trade-pos-dot zero" data-i="0"></div>
            <div class="trade-pos-dot" data-i="1"></div>
            <div class="trade-pos-dot" data-i="2"></div>
            <div class="trade-pos-dot" data-i="3"></div>
            <div class="trade-pos-dot" data-i="4"></div>
            <div class="trade-pos-dot" data-i="5"></div>
            <div class="trade-pos-dot" data-i="6"></div>
            <div class="trade-pos-dot" data-i="7"></div>
            <div class="trade-pos-dot" data-i="8"></div>
            <div class="trade-pos-dot" data-i="9"></div>
            <div class="trade-pos-dot" data-i="10"></div>
          </div>
          <small>+1000</small>
        </div>
        <div class="trade-canvas-wrap">
          <canvas id="trade-canvas" width="400" height="220"></canvas>
          <div class="trade-overlay" id="trade-overlay-start">
            <h3 data-en="SPY Day Trader" data-ro="SPY Day Trader">SPY Day Trader</h3>
            <p data-en="Trade simulated SPY in 30 seconds." data-ro="Tranzacționează SPY simulat în 30 de secunde.">Trade simulated SPY in 30 seconds.</p>
            <p style="font-size:0.8rem;color:var(--muted);margin-bottom:14px" data-en="&#9650;/&#9660; or buttons to trade &bull; Space to pause" data-ro="&#9650;/&#9660; sau butoane pt. tranzacții &bull; Space pt. pauză">&#9650;/&#9660; or buttons to trade &bull; Space to pause</p>
            <button class="trade-btn start" id="trade-start-btn" data-en="Start Trading" data-ro="Începe Tranzacția">Start Trading</button>
          </div>
          <div class="trade-overlay hidden" id="trade-overlay-pause">
            <h3 data-en="Paused" data-ro="Pauză">Paused</h3>
            <p data-en="Press Space or click to resume" data-ro="Apasă Space sau click pt. reluare">Press Space or click to resume</p>
            <div style="display:flex;gap:8px">
              <button class="trade-btn start" id="trade-resume-btn" data-en="Resume" data-ro="Reia">Resume</button>
              <button class="trade-btn end" id="trade-end-btn" data-en="End Session" data-ro="Încheie Sesiunea">End Session</button>
            </div>
          </div>
          <div class="trade-overlay hidden" id="trade-overlay-end">
            <h3 data-en="Market Closed" data-ro="Piața Închisă">Market Closed</h3>
            <div class="trade-result" id="trade-result">$0.00</div>
            <p id="trade-vol-info" style="font-size:0.85rem;color:var(--muted);margin-bottom:4px"></p>
            <p id="trade-date-info" style="font-size:0.85rem;color:var(--muted);margin-bottom:10px"></p>
            <button class="trade-btn start" id="trade-restart-btn" data-en="Trade Again" data-ro="Tranzacționează Din Nou">Trade Again</button>
          </div>
        </div>
        <div class="trade-paused-badge" id="trade-paused-badge" data-en="&#9208; PAUSED" data-ro="&#9208; PAUZĂ">&#9208; PAUSED</div>
        <div class="trade-btns">
          <button class="trade-btn buy" id="trade-buy-btn" disabled data-en="Buy +100 (&#9650;)" data-ro="Cumpără +100 (&#9650;)">Buy +100 (&#9650;)</button>
          <button class="trade-btn sell" id="trade-sell-btn" disabled data-en="Sell -100 (&#9660;)" data-ro="Vinde -100 (&#9660;)">Sell -100 (&#9660;)</button>
        </div>
        <div class="trade-hint" data-en="&#9650;/&#9660; Buy &amp; Sell &bull; <kbd>Space</kbd> Pause" data-ro="&#9650;/&#9660; Cumpără &amp; Vinde &bull; <kbd>Space</kbd> Pauză">&#9650;/&#9660; Buy &amp; Sell &bull; <kbd>Space</kbd> Pause</div>
        <div class="trade-log" id="trade-log" style="display:none">
          <h4>Trade Log</h4>
          <div class="trade-log-scroll">
            <table>
              <thead><tr>
                <th>Time</th>
                <th>Side</th>
                <th>Qty</th>
                <th>Price</th>
                <th>R. P&amp;L</th>
              </tr></thead>
              <tbody id="trade-log-body">
                <tr><td colspan="5" style="color:var(--muted);text-align:center;padding:12px 0">No trades yet</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="trade-lb" id="trade-lb">
          <div class="lb-header">
            <h4 data-en="Best Sessions" data-ro="Cele Mai Bune Sesiuni">Best Sessions</h4>
            <button class="lb-clear-btn" id="trade-clear-lb" title="Clear leaderboard"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg></button>
          </div>
          <table>
            <thead><tr>
              <th data-en="#" data-ro="#">#</th>
              <th data-en="P&amp;L" data-ro="Profit">P&amp;L</th>
              <th data-en="Vol" data-ro="Vol">Vol</th>
              <th data-en="Date" data-ro="Data">Date</th>
            </tr></thead>
            <tbody id="trade-lb-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</section>

<footer class="reveal">
  © 2025 TATOMIR N. ALEX PFA. All rights reserved.
</footer>

<script src="data/spy_data.js"></script>
<script>
// Reveal animations
const observer = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(e.isIntersecting) e.target.classList.add("visible");
  });
},{threshold:0.15});
document.querySelectorAll('.reveal').forEach(el=>observer.observe(el));

// Language toggle
const toggle = document.getElementById('lang-toggle');
let lang = 'en';
toggle.addEventListener('click', ()=>{
  lang = lang === 'en' ? 'ro' : 'en';
  toggle.textContent = lang === 'en' ? 'RO' : 'EN';
  document.querySelectorAll('[data-en]').forEach(el=>{
    el.textContent = el.getAttribute(`data-${lang}`);
  });
});

// Snake Game
(function(){
  const canvas = document.getElementById('snake-canvas');
  const ctx = canvas.getContext('2d');
  const SIZE = 20;
  const COLS = canvas.width / SIZE;
  const ROWS = canvas.height / SIZE;
  const BOMB_LIFETIME = 8000;

  // Settings
  const SNAKE_DEFAULTS = { speed:'normal', gems:'normal', shrink:'normal', bombs:'normal', walls:'on' };
  function loadSnakeSettings(){ try { return Object.assign({}, SNAKE_DEFAULTS, JSON.parse(localStorage.getItem('snakeSettings'))); } catch(e){ return Object.assign({}, SNAKE_DEFAULTS); } }
  function saveSnakeSettings(s){ localStorage.setItem('snakeSettings', JSON.stringify(s)); }
  let snakeSettings = loadSnakeSettings();

  function getSpeedParams(){
    const map = { slow:[180,0.5,80], normal:[140,1,60], fast:[100,2,40] };
    const [base, step, min] = map[snakeSettings.speed] || map.normal;
    return { BASE_SPEED:base, SPEED_STEP:step, MIN_SPEED:min };
  }
  function getSpawnDelay(setting){
    const map = { rare:[8000,12000], normal:[4000,6000], frequent:[1500,3000] };
    return map[setting] || map.normal;
  }

  function applySnakeSettingsUI(){
    document.getElementById('ss-speed').value = snakeSettings.speed;
    document.getElementById('ss-gems').value = snakeSettings.gems;
    document.getElementById('ss-shrink').value = snakeSettings.shrink;
    document.getElementById('ss-bombs').value = snakeSettings.bombs;
    document.getElementById('ss-walls').value = snakeSettings.walls;
  }
  applySnakeSettingsUI();

  let snake, dir, dirQueue, food, score, highScore, speed, loop, running, paused;
  let gem, gemTimer, bombs, bombTimer, bombTimers;
  let shrinkGem, shrinkGemTimer;

  highScore = parseInt(localStorage.getItem('snakeHigh') || '0');
  document.getElementById('snake-high').textContent = highScore;

  function loadLB(){
    let lb = JSON.parse(localStorage.getItem('snakeLB') || '[]');
    // Migrate old formats to {score, date}
    if(lb.length && typeof lb[0] === 'object' && lb[0].name) lb = lb.map(e=>({score:e.score, date:null}));
    else if(lb.length && typeof lb[0] === 'number') lb = lb.map(e=>({score:e, date:null}));
    return lb;
  }
  function saveLB(lb){ localStorage.setItem('snakeLB', JSON.stringify(lb)); }
  function fmtDate(d){ if(!d) return '—'; const dt=new Date(d); return dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}); }
  function renderLB(){
    const lb = loadLB();
    const tbody = document.getElementById('snake-lb-body');
    tbody.innerHTML = lb.length === 0
      ? '<tr><td colspan="3" style="color:var(--muted);text-align:center;padding:12px 0">—</td></tr>'
      : lb.map((e,i)=>`<tr><td>${i+1}</td><td>${e.score}</td><td style="color:var(--muted);font-size:11px">${fmtDate(e.date)}</td></tr>`).join('');
  }
  renderLB();

  function isFree(pos){
    if(snake.some(s=>s.x===pos.x&&s.y===pos.y)) return false;
    if(food&&food.x===pos.x&&food.y===pos.y) return false;
    if(gem&&gem.x===pos.x&&gem.y===pos.y) return false;
    if(shrinkGem&&shrinkGem.x===pos.x&&shrinkGem.y===pos.y) return false;
    if(bombs.some(b=>b.x===pos.x&&b.y===pos.y)) return false;
    return true;
  }
  function randFreePos(){
    let pos;
    do { pos={x:Math.floor(Math.random()*COLS),y:Math.floor(Math.random()*ROWS)}; } while(!isFree(pos));
    return pos;
  }
  function placeFood(){ food = randFreePos(); }

  function spawnGem(){
    gem = randFreePos();
    if(gemTimer) clearTimeout(gemTimer);
    gemTimer = setTimeout(()=>{ gem=null; scheduleGem(); }, 4000+Math.random()*2000);
  }
  function scheduleGem(){
    if(!running||paused) return;
    const [base,range] = getSpawnDelay(snakeSettings.gems);
    gemTimer = setTimeout(()=>{ if(running&&!paused) spawnGem(); }, base+Math.random()*range);
  }
  function spawnBomb(){
    if(!running||paused) return;
    if(snakeSettings.bombs === 'off') return;
    if(bombs.length<3){
      const b = randFreePos();
      bombs.push(b);
      const timer = setTimeout(()=>{
        const idx = bombs.indexOf(b);
        if(idx !== -1) bombs.splice(idx, 1);
        const ti = bombTimers.indexOf(timer);
        if(ti !== -1) bombTimers.splice(ti, 1);
        if(running&&!paused) draw();
      }, BOMB_LIFETIME);
      bombTimers.push(timer);
    }
    scheduleBomb();
  }
  function scheduleBomb(){
    if(!running||paused||snakeSettings.bombs==='off') return;
    const [base,range] = getSpawnDelay(snakeSettings.bombs);
    bombTimer = setTimeout(()=>{ if(running&&!paused) spawnBomb(); }, base+Math.random()*range);
  }

  function spawnShrinkGem(){
    shrinkGem = randFreePos();
    if(shrinkGemTimer) clearTimeout(shrinkGemTimer);
    shrinkGemTimer = setTimeout(()=>{ shrinkGem=null; scheduleShrinkGem(); }, 3000+Math.random()*2000);
  }
  function scheduleShrinkGem(){
    if(!running||paused) return;
    const [base,range] = getSpawnDelay(snakeSettings.shrink);
    shrinkGemTimer = setTimeout(()=>{ if(running&&!paused) spawnShrinkGem(); }, base+Math.random()*range);
  }

  function clearAllTimers(){
    if(gemTimer) clearTimeout(gemTimer);
    if(bombTimer) clearTimeout(bombTimer);
    if(bombTimers) bombTimers.forEach(t=>clearTimeout(t));
    if(shrinkGemTimer) clearTimeout(shrinkGemTimer);
  }

  function togglePause(){
    if(!running) return;
    if(paused){
      paused = false;
      loop = setInterval(tick, speed);
      document.getElementById('snake-overlay-pause').classList.add('hidden');
      scheduleGem(); scheduleBomb(); scheduleShrinkGem();
    } else {
      paused = true;
      clearInterval(loop);
      if(gemTimer) clearTimeout(gemTimer);
      if(bombTimer) clearTimeout(bombTimer);
      document.getElementById('snake-overlay-pause').classList.remove('hidden');
    }
  }

  function startGame(){
    snakeSettings = loadSnakeSettings();
    const sp = getSpeedParams();
    snake = [{x:Math.floor(COLS/2), y:Math.floor(ROWS/2)}];
    dir = {x:1,y:0}; dirQueue = [];
    score = 0; speed = sp.BASE_SPEED; running = true; paused = false;
    gem = null; shrinkGem = null; bombs = []; bombTimers = [];
    clearAllTimers();
    document.getElementById('snake-score').textContent = 0;
    placeFood(); scheduleGem(); scheduleBomb(); scheduleShrinkGem();
    document.getElementById('snake-overlay-start').classList.add('hidden');
    document.getElementById('snake-overlay-end').classList.add('hidden');
    document.getElementById('snake-overlay-pause').classList.add('hidden');
    document.getElementById('snake-settings-modal').classList.add('hidden');
    if(loop) clearInterval(loop);
    loop = setInterval(tick, speed);
  }

  function tick(){
    if(dirQueue.length) dir = dirQueue.shift();
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
    if(snakeSettings.walls === 'off'){
      if(head.x < 0) head.x = COLS - 1;
      else if(head.x >= COLS) head.x = 0;
      if(head.y < 0) head.y = ROWS - 1;
      else if(head.y >= ROWS) head.y = 0;
    } else {
      if(head.x<0||head.x>=COLS||head.y<0||head.y>=ROWS){ gameOver(); return; }
    }
    if(snake.some(s=>s.x===head.x&&s.y===head.y)){ gameOver(); return; }
    if(bombs.some(b=>b.x===head.x&&b.y===head.y)){ gameOver(); return; }
    snake.unshift(head);
    let ate = false;
    let ateGem = false;
    if(head.x===food.x&&head.y===food.y){ score++; ate = true; placeFood(); }
    if(gem&&head.x===gem.x&&head.y===gem.y){
      score += 3; ateGem = true; gem = null;
      if(gemTimer) clearTimeout(gemTimer);
      scheduleGem();
    }
    let ateShrink = false;
    if(shrinkGem&&head.x===shrinkGem.x&&head.y===shrinkGem.y){
      score += 2; ateShrink = true; shrinkGem = null;
      if(shrinkGemTimer) clearTimeout(shrinkGemTimer);
      scheduleShrinkGem();
      // Shrink: remove tail segments but keep at least 1
      const removeCount = Math.min(3, snake.length - 1);
      for(let r=0;r<removeCount;r++) snake.pop();
    }
    if(ate || ateGem || ateShrink){
      document.getElementById('snake-score').textContent = score;
      if(score>highScore){
        highScore = score;
        localStorage.setItem('snakeHigh', highScore);
        document.getElementById('snake-high').textContent = highScore;
      }
    }
    if(ate || ateGem){
      const sp = getSpeedParams();
      const newSpeed = Math.max(sp.MIN_SPEED, sp.BASE_SPEED - score * sp.SPEED_STEP);
      if(newSpeed !== speed){ speed = newSpeed; clearInterval(loop); loop = setInterval(tick, speed); }
    } else if(!ateShrink) { snake.pop(); }
    draw();
  }

  function draw(){
    ctx.fillStyle = '#0b0d10';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
    for(let x=0;x<=COLS;x++){ctx.beginPath();ctx.moveTo(x*SIZE,0);ctx.lineTo(x*SIZE,canvas.height);ctx.stroke();}
    for(let y=0;y<=ROWS;y++){ctx.beginPath();ctx.moveTo(0,y*SIZE);ctx.lineTo(canvas.width,y*SIZE);ctx.stroke();}
    ctx.fillStyle = '#fbbf24';
    ctx.beginPath(); ctx.arc(food.x*SIZE+SIZE/2, food.y*SIZE+SIZE/2, SIZE/2-2, 0, Math.PI*2); ctx.fill();
    if(gem){
      const gx=gem.x*SIZE+SIZE/2, gy=gem.y*SIZE+SIZE/2, gr=SIZE/2-2;
      ctx.fillStyle='#34d399';
      ctx.beginPath(); ctx.moveTo(gx,gy-gr); ctx.lineTo(gx+gr,gy); ctx.lineTo(gx,gy+gr); ctx.lineTo(gx-gr,gy);
      ctx.closePath(); ctx.fill();
      ctx.shadowColor='#34d399'; ctx.shadowBlur=8; ctx.fill(); ctx.shadowBlur=0;
    }
    if(shrinkGem){
      const sx=shrinkGem.x*SIZE+SIZE/2, sy=shrinkGem.y*SIZE+SIZE/2, sr=SIZE/2-1;
      ctx.fillStyle='#a855f7';
      ctx.beginPath();
      for(let i=0;i<6;i++){const a=Math.PI/6+i*Math.PI/3;ctx.lineTo(sx+sr*Math.cos(a),sy+sr*Math.sin(a));}
      ctx.closePath(); ctx.fill();
      ctx.shadowColor='#a855f7'; ctx.shadowBlur=8; ctx.fill(); ctx.shadowBlur=0;
    }
    bombs.forEach(b=>{
      ctx.fillStyle='#ef4444';
      ctx.fillRect(b.x*SIZE+2, b.y*SIZE+2, SIZE-4, SIZE-4);
      ctx.strokeStyle='#0b0d10'; ctx.lineWidth=2;
      const bx=b.x*SIZE+SIZE/2, by=b.y*SIZE+SIZE/2;
      ctx.beginPath(); ctx.moveTo(bx-3,by-3); ctx.lineTo(bx+3,by+3); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(bx+3,by-3); ctx.lineTo(bx-3,by+3); ctx.stroke();
      ctx.lineWidth=1;
    });
    snake.forEach((s,i)=>{
      ctx.fillStyle = i===0 ? '#4f8cff' : 'rgba(79,140,255,0.65)';
      ctx.beginPath(); ctx.roundRect(s.x*SIZE+1, s.y*SIZE+1, SIZE-2, SIZE-2, 4); ctx.fill();
    });
  }
  ctx.fillStyle='#0b0d10';ctx.fillRect(0,0,canvas.width,canvas.height);

  function gameOver(){
    running = false; clearInterval(loop);
    clearAllTimers();
    document.getElementById('snake-final-score').textContent = score;
    document.getElementById('snake-overlay-end').classList.remove('hidden');
    // Save score to leaderboard
    const lb = loadLB(); lb.push({score, date: new Date().toISOString()});
    lb.sort((a,b)=>b.score-a.score); if(lb.length>5) lb.length=5;
    saveLB(lb); renderLB();
  }

  const DIR_MAP = {
    ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0},
    w:{x:0,y:-1},s:{x:0,y:1},a:{x:-1,y:0},d:{x:1,y:0},
    W:{x:0,y:-1},S:{x:0,y:1},A:{x:-1,y:0},D:{x:1,y:0}
  };
  document.addEventListener('keydown', e=>{
    if((e.key===' '||e.key==='Escape') && running){ togglePause(); e.preventDefault(); return; }
    if(!running||paused) return;
    const d = DIR_MAP[e.key];
    if(d){
      const last = dirQueue.length ? dirQueue[dirQueue.length-1] : dir;
      if(d.x !== -last.x || d.y !== -last.y){ dirQueue.push(d); if(dirQueue.length>4) dirQueue.shift(); }
      e.preventDefault();
    }
  });

  document.querySelectorAll('.snake-dpad button').forEach(btn=>{
    const dirName = btn.dataset.dir;
    const map = {up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};
    btn.addEventListener('touchstart', e=>{ e.preventDefault(); if(!running||paused) return; const d=map[dirName]; const last=dirQueue.length?dirQueue[dirQueue.length-1]:dir; if(d.x!==-last.x||d.y!==-last.y){dirQueue.push(d);if(dirQueue.length>4)dirQueue.shift();} });
    btn.addEventListener('mousedown', ()=>{ if(!running||paused) return; const d=map[dirName]; const last=dirQueue.length?dirQueue[dirQueue.length-1]:dir; if(d.x!==-last.x||d.y!==-last.y){dirQueue.push(d);if(dirQueue.length>4)dirQueue.shift();} });
  });

  document.getElementById('snake-start-btn').addEventListener('click', startGame);
  document.getElementById('snake-restart-btn').addEventListener('click', startGame);
  document.getElementById('snake-resume-btn').addEventListener('click', togglePause);
  document.getElementById('snake-clear-lb').addEventListener('click', ()=>{
    if(confirm('Clear the snake leaderboard?')){
      localStorage.removeItem('snakeLB');
      renderLB();
    }
  });

  // Snake settings modal
  document.getElementById('snake-settings-btn').addEventListener('click', ()=>{
    if(running && !paused) togglePause();
    document.getElementById('snake-settings-modal').classList.remove('hidden');
  });
  document.getElementById('ss-close').addEventListener('click', ()=>{
    snakeSettings.speed = document.getElementById('ss-speed').value;
    snakeSettings.gems = document.getElementById('ss-gems').value;
    snakeSettings.shrink = document.getElementById('ss-shrink').value;
    snakeSettings.bombs = document.getElementById('ss-bombs').value;
    snakeSettings.walls = document.getElementById('ss-walls').value;
    saveSnakeSettings(snakeSettings);
    document.getElementById('snake-settings-modal').classList.add('hidden');
  });
})();

// Trading Game
(function(){
  const canvas = document.getElementById('trade-canvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const TICK = 100;
  const MULTIPLIER = 100;
  const MAX_POS = 10;

  // Settings
  const DEFAULT_SETTINGS = { dataSource: 'real', duration: 30, pnlMode: 'split', posTint: true };
  function loadSettings(){ try { return Object.assign({}, DEFAULT_SETTINGS, JSON.parse(localStorage.getItem('tradeSettings'))); } catch(e){ return Object.assign({}, DEFAULT_SETTINGS); } }
  function saveSettings(s){ localStorage.setItem('tradeSettings', JSON.stringify(s)); }
  let settings = loadSettings();
  let DURATION = settings.duration * 1000;
  let TOTAL_TICKS = DURATION / TICK;

  // Apply settings to UI
  function applySettingsUI(){
    document.getElementById('ts-source').value = settings.dataSource;
    document.getElementById('ts-duration').value = settings.duration;
    document.getElementById('ts-pnlmode').value = settings.pnlMode;
    document.getElementById('ts-postint').value = settings.posTint ? 'on' : 'off';
  }
  applySettingsUI();

  let prices, currentTick, position, pnl, running, paused, loop, tradingDate;
  let totalCost, avgPrice; // cost basis tracking
  let realizedPnl; // for split PnL mode
  let posHistory; // position at each tick for tinting
  let tradedVolume; // total $ volume traded

  function generateSimulatedPrices(){
    tradingDate = 'Simulated';
    const base = 450 + Math.random() * 150; // ~$450-$600
    const dailyVol = 0.01;
    const tickVol = dailyVol / Math.sqrt(TOTAL_TICKS);
    const pts = [base];
    for(let i = 1; i <= TOTAL_TICKS; i++){
      const ret = (Math.random() + Math.random() + Math.random() - 1.5) * tickVol;
      pts.push(pts[i-1] * (1 + ret));
    }
    return pts;
  }

  function fetchRealPrices(){
    if(settings.dataSource === 'simulated') return generateSimulatedPrices();
    // Pick a random trading day from the bundled data
    const idx = Math.floor(Math.random() * window.SPY_DATA.length);
    const [date, dayPrices] = window.SPY_DATA[idx];
    tradingDate = date;

    // Resample to TOTAL_TICKS+1 points via linear interpolation
    const resampled = [];
    for(let i = 0; i <= TOTAL_TICKS; i++){
      const t = i * (dayPrices.length - 1) / TOTAL_TICKS;
      const lo = Math.floor(t);
      const hi = Math.min(lo + 1, dayPrices.length - 1);
      const frac = t - lo;
      resampled.push(dayPrices[lo] * (1 - frac) + dayPrices[hi] * frac);
    }
    return resampled;
  }

  function loadTradeLB(){
    let lb = JSON.parse(localStorage.getItem('tradeLB')||'[]');
    // Migrate old formats
    if(lb.length && typeof lb[0] === 'number') lb = lb.map(e=>({pnl:e, date:null, vol:0}));
    else if(lb.length && typeof lb[0] === 'object' && lb[0].vol === undefined) lb = lb.map(e=>({...e, vol:0}));
    return lb;
  }
  function saveTradeLB(lb){ localStorage.setItem('tradeLB',JSON.stringify(lb)); }
  function fmtTradeDate(d){ if(!d) return '—'; const dt=new Date(d); return dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}); }
  function fmtVol(v){
    if(!v) return '—';
    if(v>=1e6) return '$'+(v/1e6).toFixed(1)+'M';
    if(v>=1e3) return '$'+(v/1e3).toFixed(0)+'K';
    return '$'+v.toFixed(0);
  }
  function renderTradeLB(){
    const lb = loadTradeLB();
    const tbody = document.getElementById('trade-lb-body');
    tbody.innerHTML = lb.length===0
      ? '<tr><td colspan="4" style="color:var(--muted);text-align:center;padding:12px 0">—</td></tr>'
      : lb.map((e,i)=>{
        const cls = e.pnl>=0?'pnl-pos':'pnl-neg';
        const sign = e.pnl>=0?'+':'-';
        return `<tr><td>${i+1}</td><td class="${cls}">${sign}$${Math.abs(e.pnl).toFixed(2)}</td><td style="color:var(--muted);font-size:11px">${fmtVol(e.vol)}</td><td style="color:var(--muted);font-size:11px">${fmtTradeDate(e.date)}</td></tr>`;
      }).join('');
  }
  renderTradeLB();

  let tradeLog = [];
  function formatTradeTime(tick){
    if(settings.dataSource === 'simulated'){
      return (tick * TICK / 1000).toFixed(1) + 's';
    }
    // Map tick to market hours 9:30–16:00
    const frac = tick / TOTAL_TICKS;
    const hours = 9.5 + frac * 6.5;
    const h = Math.floor(hours);
    const m = Math.floor((hours - h) * 60);
    const h12 = h > 12 ? h - 12 : h;
    const ampm = h >= 12 ? 'pm' : 'am';
    return h12 + ':' + String(m).padStart(2, '0') + ampm;
  }
  function logTrade(side, qty, price, rpnl){
    const time = formatTradeTime(currentTick);
    tradedVolume += qty * price;
    tradeLog.push({ time, side, qty, price, rpnl });
    renderTradeLog();
  }
  function renderTradeLog(){
    const tbody = document.getElementById('trade-log-body');
    if(!tbody) return;
    if(tradeLog.length === 0){
      tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted);text-align:center;padding:12px 0">No trades yet</td></tr>';
      return;
    }
    tbody.innerHTML = tradeLog.slice().reverse().map(t=>{
      const sideColor = t.side==='BUY'?'#34d399':'#ef4444';
      const rpnlStr = t.rpnl !== 0
        ? `<span class="${t.rpnl>=0?'pnl-pos':'pnl-neg'}">${t.rpnl>=0?'+':'-'}$${Math.abs(t.rpnl).toFixed(2)}</span>`
        : '<span style="color:var(--muted)">—</span>';
      return `<tr><td>${t.time}</td><td style="color:${sideColor};font-weight:600">${t.side}</td><td>${t.qty}</td><td>$${t.price.toFixed(2)}</td><td>${rpnlStr}</td></tr>`;
    }).join('');
  }

  function updateAvgPrice(newPos, price){
    const oldPos = position;
    let tradeRpnl = 0;
    // Track realized P&L when reducing position
    if(oldPos !== 0){
      if(newPos === 0){
        tradeRpnl = oldPos * MULTIPLIER * (price - avgPrice);
      } else if(Math.sign(newPos) !== Math.sign(oldPos)){
        tradeRpnl = oldPos * MULTIPLIER * (price - avgPrice);
      } else if(Math.abs(newPos) < Math.abs(oldPos)){
        const closed = oldPos - newPos;
        tradeRpnl = closed * MULTIPLIER * (price - avgPrice);
      }
      realizedPnl += tradeRpnl;
    }

    if(newPos === 0){ totalCost = 0; avgPrice = 0; }
    else if(Math.sign(newPos) !== Math.sign(oldPos) && oldPos !== 0){
      totalCost = newPos * price; avgPrice = price;
    } else if(Math.abs(newPos) > Math.abs(oldPos)){
      totalCost += (newPos - oldPos) * price;
      avgPrice = totalCost / newPos;
    } else if(Math.abs(newPos) < Math.abs(oldPos)){
      // Reducing position: keep avgPrice, shrink totalCost
      totalCost = newPos * avgPrice;
    }
    return tradeRpnl;
  }

  function doBuy(){
    if(!running||paused||position>=MAX_POS) return;
    const price = prices[currentTick];
    const rpnl = updateAvgPrice(position+1, price);
    position++;
    posHistory[currentTick] = position;
    logTrade('BUY', MULTIPLIER, price, rpnl);
    updatePosDisplay();
    drawChart();
  }
  function doSell(){
    if(!running||paused||position<=-MAX_POS) return;
    const price = prices[currentTick];
    const rpnl = updateAvgPrice(position-1, price);
    position--;
    posHistory[currentTick] = position;
    logTrade('SELL', MULTIPLIER, price, rpnl);
    updatePosDisplay();
    drawChart();
  }

  function togglePause(){
    if(!running) return;
    if(paused){
      paused = false;
      loop = setInterval(tick, TICK);
      document.getElementById('trade-overlay-pause').classList.add('hidden');
      document.getElementById('trade-paused-badge').classList.remove('visible');
      document.getElementById('trade-buy-btn').disabled = false;
      document.getElementById('trade-sell-btn').disabled = false;
    } else {
      paused = true;
      clearInterval(loop);
      document.getElementById('trade-overlay-pause').classList.remove('hidden');
      document.getElementById('trade-paused-badge').classList.add('visible');
      document.getElementById('trade-buy-btn').disabled = true;
      document.getElementById('trade-sell-btn').disabled = true;
    }
  }

  function updatePosDisplay(){
    const display = position * MULTIPLIER;
    document.getElementById('trade-pos').textContent = (display>0?'+':'') + display;
    document.querySelectorAll('.trade-pos-dot').forEach(dot=>{
      const i = parseInt(dot.dataset.i);
      dot.classList.remove('long','short');
      if(position>0 && i>0 && i<=position) dot.classList.add('long');
      if(position<0 && i<0 && i>=position) dot.classList.add('short');
    });
  }

  function updatePnlDisplay(){
    const isSplit = settings.pnlMode === 'split';
    document.getElementById('trade-pnl-total').style.display = isSplit ? 'none' : '';
    document.getElementById('trade-pnl-realized').style.display = isSplit ? '' : 'none';
    document.getElementById('trade-pnl-unrealized').style.display = isSplit ? '' : 'none';

    if(isSplit){
      const unrealized = (running && position !== 0) ? position * MULTIPLIER * (prices[currentTick] - avgPrice) : 0;
      const rEl = document.getElementById('trade-rpnl');
      const uEl = document.getElementById('trade-upnl');
      rEl.textContent = `${realizedPnl>=0?'+':''}$${Math.abs(realizedPnl).toFixed(2)}`;
      rEl.className = realizedPnl>=0?'pnl-pos':'pnl-neg';
      uEl.textContent = `${unrealized>=0?'+':''}$${Math.abs(unrealized).toFixed(2)}`;
      uEl.className = unrealized>=0?'pnl-pos':'pnl-neg';
    } else {
      const el = document.getElementById('trade-pnl');
      const sign = pnl>=0?'+':'';
      el.textContent = `${sign}$${Math.abs(pnl).toFixed(2)}`;
      el.className = pnl>=0?'pnl-pos':'pnl-neg';
    }
  }

  function drawChart(){
    ctx.fillStyle='#0b0d10';
    ctx.fillRect(0,0,W,H);
    if(currentTick<1) return;
    const slice = prices.slice(0, currentTick+1);
    const minP = Math.min(...slice)-0.5;
    const maxP = Math.max(...slice)+0.5;
    const range = maxP-minP||1;
    const padT=18, padB=32, padL=6, padR=6;
    const cW=W-padL-padR, cH=H-padT-padB;

    // Position tint bands
    if(settings.posTint && posHistory){
      for(let i=0;i<=currentTick;i++){
        const p = posHistory[i] || 0;
        if(p === 0) continue;
        const alpha = Math.min(Math.abs(p) / MAX_POS, 1) * 0.12;
        ctx.fillStyle = p > 0 ? `rgba(52,211,153,${alpha})` : `rgba(239,68,68,${alpha})`;
        const x0 = padL + (i / TOTAL_TICKS) * cW;
        const x1 = padL + ((i + 1) / TOTAL_TICKS) * cW;
        ctx.fillRect(x0, padT, x1 - x0, cH);
      }
    }

    ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
    for(let i=0;i<5;i++){const y=padT+cH*i/4;ctx.beginPath();ctx.moveTo(padL,y);ctx.lineTo(W-padR,y);ctx.stroke();}

    // Time labels on x-axis
    if(settings.dataSource === 'simulated'){
      ctx.fillStyle='#9aa3b2';ctx.font='9px Inter,sans-serif';ctx.textAlign='center';
      const totalSec = settings.duration;
      const step = totalSec <= 30 ? 5 : totalSec <= 60 ? 10 : 60;
      for(let s = step; s < totalSec; s += step){
        const frac = s / totalSec;
        const x = padL + frac * cW;
        ctx.beginPath();ctx.moveTo(x,padT);ctx.lineTo(x,padT+cH);ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.stroke();
        ctx.fillText(s + 's', x, padT+cH+12);
      }
    } else {
      const MARKET_START=9.5, MARKET_END=16;
      ctx.fillStyle='#9aa3b2';ctx.font='9px Inter,sans-serif';ctx.textAlign='center';
      for(let hr=10;hr<=15;hr++){
        const frac=(hr-MARKET_START)/(MARKET_END-MARKET_START);
        const x=padL+frac*cW;
        ctx.beginPath();ctx.moveTo(x,padT);ctx.lineTo(x,padT+cH);ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.stroke();
        const label=hr<=12?hr+'am':(hr-12)+'pm';
        ctx.fillText(label,x,padT+cH+12);
      }
    }

    ctx.strokeStyle='#4f8cff';ctx.lineWidth=2;ctx.beginPath();
    for(let i=0;i<=currentTick;i++){
      const x=padL+(i/TOTAL_TICKS)*cW;
      const y=padT+cH*(1-(slice[i]-minP)/range);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    const lastX=padL+(currentTick/TOTAL_TICKS)*cW;
    const lastY=padT+cH*(1-(slice[currentTick]-minP)/range);
    ctx.lineTo(lastX,padT+cH);ctx.lineTo(padL,padT+cH);ctx.closePath();
    ctx.fillStyle='rgba(79,140,255,0.08)';ctx.fill();

    // Average price horizontal line
    if(position !== 0 && avgPrice >= minP && avgPrice <= maxP){
      const avgY = padT + cH * (1 - (avgPrice - minP) / range);
      const color = position > 0 ? '#34d399' : '#ef4444';
      ctx.strokeStyle = color; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
      ctx.beginPath(); ctx.moveTo(padL, avgY); ctx.lineTo(W-padR, avgY); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = color; ctx.font = '9px Inter,sans-serif'; ctx.textAlign = 'right';
      ctx.fillText('avg $'+avgPrice.toFixed(2), W-padR, avgY-3);
    }

    ctx.fillStyle='#4f8cff';ctx.beginPath();ctx.arc(lastX,lastY,4,0,Math.PI*2);ctx.fill();

    ctx.fillStyle='#f5f7fa';ctx.font='11px Inter,sans-serif';ctx.textAlign='right';
    ctx.fillText('$'+slice[currentTick].toFixed(2),W-padR,padT-5);
    ctx.fillStyle='#9aa3b2';ctx.font='10px Inter,sans-serif';ctx.textAlign='left';
    ctx.fillText('$'+slice[0].toFixed(2),padL,padT+cH+24);
  }

  function tick(){
    if(currentTick>=TOTAL_TICKS){endGame();return;}
    const prevPrice = prices[currentTick];
    currentTick++;
    const newPrice = prices[currentTick];
    pnl += position * MULTIPLIER * (newPrice - prevPrice);
    posHistory[currentTick] = position;
    document.getElementById('trade-price').textContent = '$'+newPrice.toFixed(2);
    updatePnlDisplay();
    document.getElementById('trade-timer-fill').style.width = (currentTick/TOTAL_TICKS*100)+'%';
    drawChart();
  }

  function startGame(){
    settings = loadSettings();
    DURATION = settings.duration * 1000;
    TOTAL_TICKS = DURATION / TICK;

    prices = fetchRealPrices();

    currentTick = 0; position = 0; pnl = 0; running = true; paused = false;
    totalCost = 0; avgPrice = 0; realizedPnl = 0; tradedVolume = 0;
    posHistory = [0];
    tradeLog = [];
    document.getElementById('trade-log').style.display = '';
    document.getElementById('trade-lb').style.display = 'none';
    renderTradeLog();
    document.getElementById('trade-price').textContent = '$'+prices[0].toFixed(2);
    document.getElementById('trade-pos').textContent = '0';
    updatePnlDisplay();
    updatePosDisplay();
    document.getElementById('trade-timer-fill').style.width = '0%';
    document.getElementById('trade-overlay-start').classList.add('hidden');
    document.getElementById('trade-overlay-end').classList.add('hidden');
    document.getElementById('trade-overlay-pause').classList.add('hidden');
    document.getElementById('game-settings-modal').classList.add('hidden');
    document.getElementById('trade-paused-badge').classList.remove('visible');
    document.getElementById('trade-buy-btn').disabled = false;
    document.getElementById('trade-sell-btn').disabled = false;
    drawChart();
    if(loop) clearInterval(loop);
    loop = setInterval(tick, TICK);
  }

  function endGame(){
    running = false; paused = false;
    clearInterval(loop);
    document.getElementById('trade-buy-btn').disabled = true;
    document.getElementById('trade-sell-btn').disabled = true;
    document.getElementById('trade-overlay-pause').classList.add('hidden');
    document.getElementById('trade-paused-badge').classList.remove('visible');
    const el = document.getElementById('trade-result');
    const sign = pnl>=0?'+':'';
    el.textContent = `${sign}$${Math.abs(pnl).toFixed(2)}`;
    el.style.color = pnl>=0?'#34d399':'#ef4444';

    // Show date and chart link
    document.getElementById('trade-vol-info').textContent = 'Volume: ' + fmtVol(tradedVolume);
    const dateInfo = document.getElementById('trade-date-info');
    if(tradingDate === 'Simulated'){
      dateInfo.innerHTML = `Trading day: <strong>Simulated</strong>`;
    } else {
      const formattedDate = new Date(tradingDate + 'T12:00:00').toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric'
      });
      const d = new Date(tradingDate + 'T00:00:00');
      const p1 = Math.floor(d.getTime()/1000);
      const p2 = p1 + 86400;
      const yahooUrl = `https://finance.yahoo.com/quote/SPY/history/?period1=${p1}&period2=${p2}`;
      dateInfo.innerHTML = `Trading day: <strong>${formattedDate}</strong><br><a href="${yahooUrl}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;font-size:0.8rem">View on Yahoo Finance &rarr;</a>`;
    }

    // Show total PnL at game end regardless of mode
    document.getElementById('trade-pnl-total').style.display = '';
    document.getElementById('trade-pnl-realized').style.display = 'none';
    document.getElementById('trade-pnl-unrealized').style.display = 'none';
    const pnlEl = document.getElementById('trade-pnl');
    const pnlSign = pnl>=0?'+':'';
    pnlEl.textContent = `${pnlSign}$${Math.abs(pnl).toFixed(2)}`;
    pnlEl.className = pnl>=0?'pnl-pos':'pnl-neg';

    document.getElementById('trade-overlay-end').classList.remove('hidden');
    const lb = loadTradeLB();
    lb.push({pnl: parseFloat(pnl.toFixed(2)), vol: Math.round(tradedVolume), date: new Date().toISOString()});
    lb.sort((a,b)=>b.pnl-a.pnl);
    if(lb.length>5) lb.length=5;
    saveTradeLB(lb);
    renderTradeLB();
    document.getElementById('trade-log').style.display = 'none';
    document.getElementById('trade-lb').style.display = '';
  }

  // Settings modal
  document.getElementById('game-settings-btn').addEventListener('click', ()=>{
    if(running && !paused) togglePause();
    document.getElementById('game-settings-modal').classList.remove('hidden');
  });
  document.getElementById('ts-close').addEventListener('click', ()=>{
    settings.dataSource = document.getElementById('ts-source').value;
    settings.duration = parseInt(document.getElementById('ts-duration').value);
    settings.pnlMode = document.getElementById('ts-pnlmode').value;
    settings.posTint = document.getElementById('ts-postint').value === 'on';
    saveSettings(settings);
    // Apply PnL mode immediately if a game is running
    if(running) updatePnlDisplay();
    document.getElementById('game-settings-modal').classList.add('hidden');
  });
  document.getElementById('trade-clear-lb').addEventListener('click', ()=>{
    if(confirm('Clear the trading leaderboard?')){
      localStorage.removeItem('tradeLB');
      renderTradeLB();
    }
  });

  document.getElementById('trade-buy-btn').addEventListener('click', doBuy);
  document.getElementById('trade-sell-btn').addEventListener('click', doSell);
  document.getElementById('trade-start-btn').addEventListener('click', startGame);
  document.getElementById('trade-restart-btn').addEventListener('click', startGame);
  document.getElementById('trade-resume-btn').addEventListener('click', togglePause);
  document.getElementById('trade-end-btn').addEventListener('click', ()=>{ if(running) endGame(); });

  document.addEventListener('keydown', e=>{
    if((e.key===' '||e.key==='Escape') && running){ togglePause(); e.preventDefault(); return; }
    if(!running||paused) return;
    if(e.key==='ArrowUp'||e.key==='ArrowRight'){doBuy();e.preventDefault();}
    if(e.key==='ArrowDown'||e.key==='ArrowLeft'){doSell();e.preventDefault();}
  });

  ctx.fillStyle='#0b0d10';ctx.fillRect(0,0,W,H);
})();
</script>

</body>
</html>
